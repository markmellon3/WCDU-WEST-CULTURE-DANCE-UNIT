<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WCDU Donation Impact Admin</title>
  <!-- Favicon -->
<link rel="icon" type="image/webp" sizes="16x16" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">
<link rel="icon" type="image/webp" sizes="32x32" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">
<link rel="icon" type="image/webp" sizes="96x96" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">

<link rel="apple-touch-icon" sizes="180x180" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px;
      background: #f8f9fa;
      color: #333;
    }
    h1, h2 { 
      text-align: center; 
      color: #1a1a1a; 
      margin-bottom: 0.4em; 
    }
    .subtitle { 
      text-align: center; 
      color: #666; 
      margin-bottom: 2rem; 
    }
    
    form {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 2.5rem;
    }
    label { 
      display: block; 
      margin: 1.2rem 0 0.5rem; 
      font-weight: 600; 
      color: #444; 
    }
    input, textarea {
      width: 100%;
      padding: 0.9rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input:focus { 
      outline: none; 
      border-color: #2196F3; 
      box-shadow: 0 0 0 3px rgba(33,150,243,0.15); 
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 0.9rem 1.8rem;
      border-radius: 6px;
      font-size: 1.05rem;
      cursor: pointer;
      margin-top: 1.2rem;
    }
    button:hover { background: #1976D2; }
    button:disabled { background: #aaa; cursor: not-allowed; }

    .multi-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f0f0f0;
      border-radius: 8px;
      min-height: 100px;
    }
    .thumb {
      position: relative;
      width: 140px;
      height: 140px;
      background: #ddd;
      border-radius: 6px;
      overflow: hidden;
    }
    .thumb img, .thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .or-divider {
      text-align: center;
      margin: 1.5rem 0;
      color: #777;
      font-weight: 500;
    }

    #donation-list:empty::before {
      content: "No donation impact media added yet.";
      display: block;
      text-align: center;
      color: #888;
      padding: 3rem 0;
      font-style: italic;
    }

    .donation-item {
      background: white;
      padding: 1.2rem;
      margin: 1rem 0;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      gap: 1.2rem;
      align-items: center;
    }
    .donation-item img, .donation-item video {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }
    .item-info { flex: 1; }
    .delete-btn {
      background: #e53935;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .delete-btn:hover { background: #c62828; }
  </style>
</head>
<body>

  <h1>WCDU Donation Admin</h1>
  <p class="subtitle">Add & manage impact photos and videos that show where donations go</p>

  <form id="donationForm">
    <h2>Add Donation Impact Media</h2>

    <label for="filesInput">Select multiple images (max 20)</label>
    <input type="file" id="filesInput" accept="image/*" multiple>

    <div class="or-divider">— OR paste direct link —</div>

    <label for="manualUrl">Paste image or video URL (YouTube, direct mp4, etc.)</label>
    <input type="url" id="manualUrl" placeholder="https://...jpg / https://...mp4">

    <div class="multi-preview" id="multiPreview"></div>

    <label for="caption">Caption / Short Description</label>
    <input type="text" id="caption" placeholder="Giving school supplies to kids">

    <label for="description">Longer Description (optional)</label>
    <textarea id="description" rows="2" placeholder="Kids from the community receiving books and uniforms..."></textarea>

    <button type="submit" id="submitBtn" disabled>Add to Donation Gallery</button>
    <span id="statusLine" style="margin-left:1rem; color:#555;"></span>
  </form>

  <h2>Donation Impact Items (Newest on Top)</h2>
  <div id="donation-list"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, push, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmEy3DcuhuSsPxQml332xalyQJVWLd4uw",
      authDomain: "wcdu-955cb.firebaseapp.com",
      projectId: "wcdu-955cb",
      storageBucket: "wcdu-955cb.firebasestorage.app",
      messagingSenderId: "381070884807",
      appId: "1:381070884807:web:e02f4e3e3e34399f50e3e2",
      measurementId: "G-2DXFQ992WK",
      databaseURL: "https://wcdu-955cb-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const donationRef = ref(db, 'donation');

    const IMGBB_KEY = "47f7dff148164ff31a5947e6ee635363";
    const MAX_FILES = 20;

    const filesInput     = document.getElementById('filesInput');
    const manualUrlInput = document.getElementById('manualUrl');
    const previewCont    = document.getElementById('multiPreview');
    const submitBtn      = document.getElementById('submitBtn');
    const statusLine     = document.getElementById('statusLine');
    const captionInput   = document.getElementById('caption');
    const descInput      = document.getElementById('description');

    let selectedFiles = [];

    // File selection + preview
    filesInput.addEventListener('change', () => {
      selectedFiles = Array.from(filesInput.files).slice(0, MAX_FILES);
      previewCont.innerHTML = '';
      submitBtn.disabled = (selectedFiles.length === 0 && !manualUrlInput.value.trim());

      selectedFiles.forEach((file, i) => {
        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        thumb.appendChild(img);
        previewCont.appendChild(thumb);
      });

      statusLine.textContent = selectedFiles.length ? `${selectedFiles.length} image(s) selected` : '';
    });

    manualUrlInput.addEventListener('input', () => {
      submitBtn.disabled = (!manualUrlInput.value.trim() && selectedFiles.length === 0);
    });

    // Upload to ImgBB (images only)
    async function uploadImage(file) {
      const fd = new FormData();
      fd.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
      const data = await res.json();
      if (data.success) return data.data.url;
      throw new Error(data.error?.message || 'Upload failed');
    }

    // Submit form
    document.getElementById('donationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const caption = captionInput.value.trim() || 'Impact moment';
      const description = descInput.value.trim() || null;
      const manualUrl = manualUrlInput.value.trim();

      submitBtn.disabled = true;
      statusLine.textContent = 'Processing...';

      try {
        // Single manual URL (image or video)
        if (manualUrl) {
          const newRef = push(donationRef);
          const type = manualUrl.match(/\.(mp4|webm|ogg)$/i) ? 'video' : 'image';
          await set(newRef, {
            url: manualUrl,
            caption,
            description,
            createdAt: new Date().toISOString(),
            type
          });
        }

        // Bulk images
        if (selectedFiles.length > 0) {
          let success = 0;
          for (let i = 0; i < selectedFiles.length; i++) {
            try {
              const url = await uploadImage(selectedFiles[i]);
              const newRef = push(donationRef);
              const suffix = selectedFiles.length > 1 ? ` #${i+1}` : '';
              await set(newRef, {
                url,
                caption: caption + suffix,
                description,
                createdAt: new Date().toISOString(),
                type: 'image'
              });
              success++;
            } catch (err) {
              console.error('Upload failed:', err);
            }
          }
          statusLine.textContent = `Added ${success}/${selectedFiles.length} images`;
        }

        // Reset form
        filesInput.value = '';
        manualUrlInput.value = '';
        captionInput.value = '';
        descInput.value = '';
        selectedFiles = [];
        previewCont.innerHTML = '';
        submitBtn.disabled = true;
      } catch (err) {
        statusLine.textContent = 'Error: ' + err.message;
        console.error(err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Real-time list – newest first (sorted by push key)
    onValue(donationRef, (snapshot) => {
      const list = document.getElementById('donation-list');
      list.innerHTML = '';

      if (!snapshot.exists()) {
        list.innerHTML = '<div class="empty-list">No items yet.</div>';
        return;
      }

      const items = [];
      snapshot.forEach(child => {
        items.push({ key: child.key, ...child.val() });
      });

      // Sort by key descending (newest first)
      items.sort((a, b) => b.key.localeCompare(a.key));

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'donation-item';

        const isVideo = item.type === 'video' || item.url?.match(/\.(mp4|webm|ogg)$/i);

        div.innerHTML = `
          <div>
            ${item.url ? (isVideo
              ? `<video src="${item.url}" controls></video>`
              : `<img src="${item.url}" alt="${item.caption || 'media'}">`) : ''}
          </div>
          <div class="item-info">
            <strong>${item.caption || 'No caption'} ${isVideo ? '(Video)' : ''}</strong><br>
            <small>${item.description || ''}</small><br>
            ${isVideo ? `<a href="${item.url}" target="_blank">Open video →</a>` : ''}
          </div>
          <button class="delete-btn" data-key="${item.key}">Delete</button>
        `;

        list.appendChild(div);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Delete this item?')) {
            remove(ref(db, `donation/${btn.dataset.key}`));
          }
        });
      });
    });
  </script>
</body>
</html>