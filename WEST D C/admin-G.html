<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WCDU Gallery Admin – Bulk + Manual</title>
  <!-- Favicon -->
<link rel="icon" type="image/webp" sizes="16x16" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">
<link rel="icon" type="image/webp" sizes="32x32" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">
<link rel="icon" type="image/webp" sizes="96x96" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">

<link rel="apple-touch-icon" sizes="180x180" href="https://ik.imagekit.io/s95tumxuk/Gemini_Generated_Image_7xjzql7xjzql7xjz.png">
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px;
      background: #f8f9fa;
      color: #333;
    }
    h1, h2 { text-align: center; color: #1a1a1a; margin-bottom: 0.4em; }
    .subtitle { text-align: center; color: #666; margin-bottom: 2rem; }
    
    form {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 2.5rem;
    }
    label { display: block; margin: 1.2rem 0 0.5rem; font-weight: 600; color: #444; }
    input, textarea {
      width: 100%;
      padding: 0.9rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 0 3px rgba(76,175,80,0.15); }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 0.9rem 1.8rem;
      border-radius: 6px;
      font-size: 1.05rem;
      cursor: pointer;
      margin-top: 1.2rem;
    }
    button:hover { background: #43a047; }
    button:disabled { background: #aaa; cursor: not-allowed; }

    .multi-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f0f0f0;
      border-radius: 8px;
      min-height: 100px;
    }
    .thumb {
      position: relative;
      width: 140px;
      height: 140px;
      background: #ddd;
      border-radius: 6px;
      overflow: hidden;
    }
    .thumb img, .thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumb-status {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 0.75rem;
      text-align: center;
      padding: 4px;
    }
    .status-success  { background: rgba(76,175,80,0.9); }
    .status-error    { background: rgba(244,67,54,0.9); }
    .status-skipped  { background: rgba(255,152,0,0.9); }

    #gallery-list:empty::before {
      content: "No media items yet.";
      display: block;
      text-align: center;
      color: #888;
      padding: 3rem 0;
      font-style: italic;
    }

    .gallery-item {
      background: white;
      padding: 1.2rem;
      margin: 1rem 0;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      gap: 1.2rem;
      align-items: center;
    }
    .gallery-item img, .gallery-item video {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }
    .item-info { flex: 1; }
    .delete-btn {
      background: #e53935;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .delete-btn:hover { background: #c62828; }

    .or-divider {
      text-align: center;
      margin: 1.5rem 0;
      color: #777;
      font-weight: 500;
    }
  </style>
</head>
<body>

  <h1>WCDU Gallery Admin</h1>
  <p class="subtitle">Bulk upload images + manual video/image links (newest first)</p>

  <form id="mediaForm">
    <h2>Add Media</h2>

    <label for="filesInput">Select multiple images (max 20) – videos not supported here</label>
    <input type="file" id="filesInput" accept="image/*" multiple>

    <div class="or-divider">— OR paste direct link —</div>

    <label for="manualUrl">Paste image or video URL (YouTube, mp4 link, etc.)</label>
    <input type="url" id="manualUrl" placeholder="https://youtu.be/... or https://.../video.mp4">

    <div class="multi-preview" id="multiPreview"></div>

    <label for="titleBase">Base Title (auto-numbers when bulk uploading)</label>
    <input type="text" id="titleBase" placeholder="Street Battle 2025" value="Performance">

    <label for="description">Common Description (optional)</label>
    <textarea id="description" rows="2" placeholder="Moment from ..."></textarea>

    <button type="submit" id="submitBtn" disabled>Add to Gallery</button>
    <span id="statusLine" style="margin-left:1rem; color:#555;"></span>
  </form>

  <h2>Gallery Items (Newest on Top)</h2>
  <div id="gallery-list"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, push, set, remove, onValue, query, orderByChild } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmEy3DcuhuSsPxQml332xalyQJVWLd4uw",
      authDomain: "wcdu-955cb.firebaseapp.com",
      projectId: "wcdu-955cb",
      storageBucket: "wcdu-955cb.firebasestorage.app",
      messagingSenderId: "381070884807",
      appId: "1:381070884807:web:e02f4e3e3e34399f50e3e2",
      measurementId: "G-2DXFQ992WK",
      databaseURL: "https://wcdu-955cb-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const galleryRef = ref(db, 'gallery');

    const IMGBB_KEY = "47f7dff148164ff31a5947e6ee635363";
    const MAX_FILES = 20;

    const filesInput     = document.getElementById('filesInput');
    const manualUrlInput = document.getElementById('manualUrl');
    const previewCont    = document.getElementById('multiPreview');
    const submitBtn      = document.getElementById('submitBtn');
    const statusLine     = document.getElementById('statusLine');
    const titleBaseInput = document.getElementById('titleBase');
    const descInput      = document.getElementById('description');

    let selectedFiles = [];

    // ────────────────────────────────────────────────
    //  File selection + preview
    // ────────────────────────────────────────────────
    filesInput.addEventListener('change', () => {
      selectedFiles = Array.from(filesInput.files).slice(0, MAX_FILES);
      previewCont.innerHTML = '';
      submitBtn.disabled = (selectedFiles.length === 0 && !manualUrlInput.value.trim());

      selectedFiles.forEach((file, i) => {
        const thumb = document.createElement('div');
        thumb.className = 'thumb';

        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        thumb.appendChild(img);

        previewCont.appendChild(thumb);
      });

      statusLine.textContent = selectedFiles.length ? `${selectedFiles.length} image(s) selected` : '';
    });

    // Enable/disable submit when manual URL changes
    manualUrlInput.addEventListener('input', () => {
      submitBtn.disabled = (!manualUrlInput.value.trim() && selectedFiles.length === 0);
    });

    // ────────────────────────────────────────────────
    //  Upload to ImgBB (images only)
    // ────────────────────────────────────────────────
    async function uploadImage(file) {
      const fd = new FormData();
      fd.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
      const data = await res.json();
      if (data.success) return data.data.url;
      throw new Error(data.error?.message || 'Upload failed');
    }

    // ────────────────────────────────────────────────
    //  Submit form – handle bulk images OR single manual URL
    // ────────────────────────────────────────────────
    document.getElementById('mediaForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const baseTitle = titleBaseInput.value.trim() || 'Untitled';
      const description = descInput.value.trim() || null;
      const manualUrl = manualUrlInput.value.trim();

      submitBtn.disabled = true;
      statusLine.textContent = 'Processing...';

      try {
        if (manualUrl) {
          // Single manual URL (video or image)
          const newRef = push(galleryRef);
          const type = manualUrl.match(/\.(mp4|webm|ogg)$/i) ? 'video' : 'image';
          await set(newRef, {
            url: manualUrl,
            title: baseTitle,
            description,
            createdAt: new Date().toISOString(),
            type
          });
          statusLine.textContent = 'Added successfully!';
        }

        if (selectedFiles.length > 0) {
          // Bulk images
          let success = 0;
          for (let i = 0; i < selectedFiles.length; i++) {
            try {
              const url = await uploadImage(selectedFiles[i]);
              const newRef = push(galleryRef);
              const suffix = selectedFiles.length > 1 ? ` #${i+1}` : '';
              await set(newRef, {
                url,
                title: baseTitle + suffix,
                description,
                createdAt: new Date().toISOString(),
                type: 'image'
              });
              success++;
            } catch (err) {
              console.error('Upload failed:', err);
            }
          }
          statusLine.textContent = `Added ${success}/${selectedFiles.length} images`;
        }

        // Reset form
        filesInput.value = '';
        manualUrlInput.value = '';
        selectedFiles = [];
        previewCont.innerHTML = '';
        submitBtn.disabled = true;
      } catch (err) {
        statusLine.textContent = 'Error: ' + err.message;
        console.error(err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ────────────────────────────────────────────────
    //  Show gallery – newest first
    // ────────────────────────────────────────────────
    onValue(query(galleryRef, orderByChild('createdAt')), (snapshot) => {
      const list = document.getElementById('gallery-list');
      list.innerHTML = '';

      if (!snapshot.exists()) return;

      // Collect and reverse (newest on top)
      const items = [];
      snapshot.forEach(child => {
        items.push({ key: child.key, ...child.val() });
      });
      items.reverse(); // newest first

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'gallery-item';

        const isVideo = item.type === 'video' || item.url?.match(/\.(mp4|webm|ogg)$/i);

        div.innerHTML = `
          <div>
            ${item.url ? (isVideo
              ? `<video src="${item.url}" controls></video>`
              : `<img src="${item.url}" alt="${item.title || 'media'}">`) : ''}
          </div>
          <div class="item-info">
            <strong>${item.title || 'No title'} ${isVideo ? '(Video)' : ''}</strong><br>
            <small>${item.description || ''}</small><br>
            ${isVideo ? `<a href="${item.url}" target="_blank">Open video →</a>` : ''}
          </div>
          <button class="delete-btn" data-key="${item.key}">Delete</button>
        `;

        list.appendChild(div);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Delete this item?')) {
            remove(ref(db, `gallery/${btn.dataset.key}`));
          }
        });
      });
    });
  </script>
</body>
</html>